{% assign total_compare_at_price = 0 %}
{% assign total_line_discounts = 0 %}
{% assign total_cart_discounts = 0 %}

{% for item in cart.items %}
  {% if item.variant.compare_at_price > item.original_price %}
    {% assign compare_discount = item.variant.compare_at_price | minus: item.original_price %}
    {% assign compare_discount_total = compare_discount | times: item.quantity %}
    {% assign total_compare_at_price = total_compare_at_price | plus: compare_discount_total %}
  {% endif %}

  {% for discount_allocation in item.line_level_discount_allocations %}
    {% assign total_line_discounts = total_line_discounts | plus: discount_allocation.amount %}
  {% endfor %}
{% endfor %}

{% for discount_application in cart.cart_level_discount_applications %}
  {% assign total_cart_discounts = total_cart_discounts | plus: discount_application.total_allocated_amount %}
{% endfor %}

{% assign total_discounts = total_compare_at_price | plus: total_line_discounts | plus: total_cart_discounts %}

{% if total_discounts > 0 %}
  <div class="cart-total-discount discounts">
    <div class="discounts__discount discounts__discount--position">
      <span class="discounts__discount-text font-medium">
        <span class="svg-wrapper">
        {{- 'icon-discount.svg' | inline_asset_content -}}
        </span>
        <text-loader-component 
          class="discounts__discount discounts__discount--position"
          value="{{ 'customer.order.discount' | t }} ({{ total_discounts | money }})"
        >
          {{ 'customer.order.discount' | t }}
          (-{{ total_discounts | money }})
        </text-loader-component>
      </span>
    </div>
  </div>
{% endif %}


<div class="totals">
  <h2 class="totals__total">{{ 'content.estimated_total' | t }}</h2>
  <text-loader-component
    class="totals__total-value"
    value="{{ cart.total_price | money_with_currency }}"
  >
    {{ cart.total_price | money_with_currency }}
  </text-loader-component>
</div>

<small class="tax-note caption-large rte">
  {%- if cart.duties_included and cart.taxes_included -%}
    {%- if shop.shipping_policy.body == blank -%}
      {%- if total_discounts > 0 -%}
        {{ 'content.duties_and_taxes_included_shipping_at_checkout_without_policy_without_discounts' | t }}
      {%- else -%}
        {{ 'content.duties_and_taxes_included_shipping_at_checkout_without_policy' | t }}
      {%- endif -%}
    {%- else -%}
      {%- if total_discounts > 0 -%}
        {{
          'content.duties_and_taxes_included_shipping_at_checkout_with_policy_without_discounts_html'
          | t: link: shop.shipping_policy.url
        }}
      {%- else -%}
        {{
          'content.duties_and_taxes_included_shipping_at_checkout_with_policy_html'
          | t: link: shop.shipping_policy.url
        }}
      {%- endif -%}
    {%- endif -%}
  {%- elsif cart.duties_included == false and cart.taxes_included -%}
    {%- if shop.shipping_policy.body == blank -%}
      {%- if total_discounts > 0 -%}
        {{ 'content.duties_and_taxes_included_shipping_at_checkout_without_policy_without_discounts' | t }}
      {%- else -%}
        {{ 'content.taxes_included_shipping_at_checkout_without_policy' | t }}
      {%- endif -%}
    {%- else -%}
      {%- if total_discounts > 0 -%}
        {{
          'content.duties_and_taxes_included_shipping_at_checkout_with_policy_without_discounts_html'
          | t: link: shop.shipping_policy.url
        }}
      {%- else -%}
        {{ 'content.taxes_included_shipping_at_checkout_with_policy_html' | t: link: shop.shipping_policy.url }}
      {%- endif -%}
    {%- endif -%}
  {%- elsif cart.duties_included and cart.taxes_included == false -%}
    {%- if shop.shipping_policy.body == blank -%}
      {%- if total_discounts > 0 -%}
        {{ 'content.duties_included_taxes_at_checkout_shipping_at_checkout_without_policy_without_discounts' | t }}
      {%- else -%}
        {{ 'content.duties_included_taxes_at_checkout_shipping_at_checkout_without_policy' | t }}
      {%- endif -%}
    {%- else -%}
      {%- if total_discounts > 0 -%}
        {{
          'content.duties_included_taxes_at_checkout_shipping_at_checkout_with_policy_without_discounts_html'
          | t: link: shop.shipping_policy.url
        }}
      {%- else -%}
        {{
          'content.duties_included_taxes_at_checkout_shipping_at_checkout_with_policy_html'
          | t: link: shop.shipping_policy.url
        }}
      {%- endif -%}
    {%- endif -%}
  {%- elsif cart.duties_included == false and cart.taxes_included == false -%}
    {%- if shop.shipping_policy.body == blank -%}
      {%- if total_discounts > 0 -%}
        {{ 'content.taxes_at_checkout_shipping_at_checkout_without_policy_without_discounts' | t }}
      {%- else -%}
        {{ 'content.taxes_at_checkout_shipping_at_checkout_without_policy' | t }}
      {%- endif -%}
    {%- else -%}
      {%- if total_discounts > 0 -%}
        {{
          'content.taxes_at_checkout_shipping_at_checkout_with_policy_without_discounts_html'
          | t: link: shop.shipping_policy.url
        }}
      {%- else -%}
        {{ 'content.taxes_at_checkout_shipping_at_checkout_with_policy_html' | t: link: shop.shipping_policy.url }}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}
</small>
