{%- doc -%}
  Renders text that stretches to fit the full width of its container.

  @param {string} [text] - The text to be rendered.
  @param {object} [block] - The block object

  @example
  {% render 'jumbo-text', text: block.settings.text %}
{%- enddoc -%}

{% liquid
  assign bl_stts = block.settings
  assign shown_text = text | default: bl_stts.text
  assign descenders = 'alphabetic'
  assign trim = 'trim-both'

  unless bl_stts.case == 'uppercase'
    if shown_text contains 'g' or shown_text contains 'j' or shown_text contains 'p' or shown_text contains 'q' or shown_text contains 'y'
      assign descenders = 'text'
    endif
  endunless

  assign text_trim = trim | append: ' cap ' | append: descenders
  assign shown_text_with_line_breaks = shown_text | newline_to_br
  assign text_with_lines = shown_text_with_line_breaks | split: '<br />'
  assign nudge = '-0.04em'
%}

{% capture attributes %}
  style="
    --font-family: var(--font-{{ bl_stts.font | default: 'body'}}--family);
    --font-weight: var(--font-{{ bl_stts.font | default: 'body'}}--weight);
    {% if bl_stts.font == 'body' %}
      --color: var(--color-foreground);
    {% else %}
      --color: var(--color-foreground-heading);
    {% endif %}
    --text-align: {{ bl_stts.alignment | default: 'left' }};
    {% if bl_stts.alignment == "left" %}
      --margin-left-nudge: {{nudge}};
    {% elsif bl_stts.alignment == "right" %}
      --margin-right-nudge: {{nudge}};
    {% endif %}
    --line-height: {{ bl_stts.line_height | default: '1' }};
    --letter-spacing: {{ bl_stts.letter_spacing | default: '-0.03em' }};
    --text-transform: {{ bl_stts.case | default: 'none' }};
    --text-trim: {{text_trim}};
  "
  {{ block.shopify_attributes }}
{% endcapture %}

{% comment %}
  If the jumbo text is not wrapped inside its own container, the overflow calculation does not always work correctly
  (looks like some weird off-by-one error when comparing sizes).
{% endcomment %}
<div 
  class="
    jumbo-text__container size-style
    {% if bl_stts.inherit_color_scheme == false %}color-scheme-custom{% endif %}
  "
  style="
    {% render 'size-style', settings: bl_stts %}
    {% if bl_stts.inherit_color_scheme == false %}
      {% render 'color-scheme-style', settings: bl_stts %}
    {% endif %}
  "
>
  {% if text != blank %}
    <jumbo-text {{ attributes }}>{{ text }}</jumbo-text>
  {% else %}
    <span class="visually-hidden">{{ shown_text }}</span>
    <jumbo-text
      {{ attributes }}
      data-text-effect="{{ bl_stts.text_effect }}"
      data-animation-repeat="{{ bl_stts.animation_repeat }}"
    >
      {%- assign char_index = 0 -%}
      {%- for line in text_with_lines -%}
        {%- if forloop.index > 1 -%}
          <br>
        {%- endif -%}
        <span
          class="jumbo-text-line"
          style="--line-index: {{ forloop.index }};"
          data-testid="jumbo-text-line"
          aria-hidden="true"
        >
          {%- assign chars = line | split: ' ' | join: ' ' | split: '' -%}
          {%- for char in chars -%}
            {%- if char == ' ' -%}
              <span
                class="jumbo-text-space"
                aria-hidden="true"
              >
                {{ char }}
              </span>
            {%- else -%}
              <span
                class="jumbo-text-char"
                style="--char-index: {{ char_index }};"
                aria-hidden="true"
              >
                <span class="jumbo-text-char-inner">{{ char }}</span>
              </span>
              {%- assign char_index = char_index | plus: 1 -%}
            {%- endif -%}
          {%- endfor -%}
        </span>
      {%- endfor -%}
    </jumbo-text>
  {% endif %}

  <script src="{{ 'jumbo-text.js' | asset_url }}" defer="defer" ></script>
</div>
