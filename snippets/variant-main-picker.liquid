{%- doc -%}
  Renders a default variant picker, used to display the variant picker in the variants block.

  @param {object} product_resource - The product object.
  @param {object} [block] - The block object
{%- enddoc -%}

{%- liquid
  assign bl_stts = block.settings
  assign custom_fields = product.metafields.custom.combined_products_listing
-%}

{% unless product_resource.has_only_default_variant %}
  {{ 'component-product-variant-picker.css' | asset_url | stylesheet_tag }}
  {{ 'component-swatch-input.css' | asset_url | stylesheet_tag }}
  {{ 'component-swatch.css' | asset_url | stylesheet_tag }}

  <variant-selects
    id="variant-selects-{{ block.id }}"
    class="variant-selects spacing-style variant-selects--{{ bl_stts.alignment }}"
    style="{% render 'spacing-style', settings: bl_stts %}"
    data-section="{{ block.id }}"
    data-section-id="{{ block.id }}"
    data-product-id="{{ product_resource.id }}"
    data-block-id="{{ block.id }}"
    data-product-url="{{ product_resource.url }}"
    {% if context %}
      data-context="{{ context }}"
    {% endif %}
    ref="mainVariantSelects"
    {% if product.id == product_resource.id %}
      data-template-product-match="true"
    {% endif %}
    {{ block.shopify_attributes }}
    {% if request.visual_preview_mode %}
      data-shopify-visual-preview
    {% endif %}
  >
    {%- if custom_fields != blank and settings.enable_combined_products_listing -%}
    <div class="swatch-custom product-form__input">
      <p class="form__label-combined form__label">{{ 'products.product.color' | t }}<span>{{ product.metafields.custom.combined_products_listing_name_color }}</span></p>
      <ul class="list-unstyled flex flex-align-center flex-wrap">
        {%- for referenced_product in custom_fields.value -%}
          {%- liquid
            assign image_custom = referenced_product.metafields.custom.combined_products_listing_image.value
          -%}
          <li class="item-custom{% if referenced_product.id == product.id %} active{% endif %} swatch-item relative">
            <div class="item-custom--image">
              <{% if referenced_product.id == product.id %}span{% else %}a href ="{{shop.url | append: "/products/" | append: referenced_product.handle }}"{% endif %}
                class="item-custom--inner swatch"
                style="
                  {%- if image_custom != blank -%}
                    background: url({{ image_custom | img_url: 'medium' }});
                  {%- else -%}
                    background: url({{ referenced_product.featured_image | img_url: 'medium' }});
                  {%- endif -%}
                  background-size: cover;"
                title="{{referenced_product.title}}"
              >
              </{% if referenced_product.id == product.id %}span{% else %}a{% endif %}>
            </div>
          </li>
        {%- endfor -%}
      </ul>
    </div>
    {%- endif -%}
    {%- for product_option in product_resource.options_with_values -%}
      {%- liquid
        assign variant_style = bl_stts.variant_style
        assign show_swatches = bl_stts.show_swatches
        assign swatch_size = bl_stts.swatch_size
        assign product_swatch_option = settings.swatch | downcase
        assign swatch_type = settings.swatch_type
        assign option_name = product_option.name | downcase
        assign is_color = false
        if show_swatches and product_swatch_option contains option_name
          assign is_color = true
        endif

        if is_color
          if bl_stts.variant_style == 'dropdowns'
            assign variant_style = 'dropdowns'
          else
            assign variant_style = 'swatch'
          endif
        endif
      -%}
      {%- if variant_style == 'pills' or variant_style == 'swatch' -%}
        <fieldset  class="js product-form__input variant-option variant-option--buttons{% if is_color %} product-form__input--swatch variant-option--swatches{% else %} product-form__input--pill variant-option--pill{% endif %}">
          <legend class="form__label">
            {{ product_option.name  | escape }}:
            <span data-selected-value>
              {{- product_option.selected_value -}}
            </span>
          </legend>
          {% render 'product-variant-options',
            option: product_option,
            block: block,
            variant_style: variant_style,
            swatch_type: swatch_type,
            swatch_size: swatch_size,
            is_color: is_color,
            index: forloop.index0,
            product: product_resource
          %}
        </fieldset>
      {%- elsif variant_style == 'dropdowns' -%}
        {% liquid
          assign property_being_updated = false
          if settings.variant_swatch_width != settings.variant_swatch_height
            assign property_being_updated = true
            assign new_width = settings.variant_swatch_width | times: 1.0 | divided_by: settings.variant_swatch_height | times: 20
          endif
        %}
        <div class="product-form__input product-form__input--dropdown variant-option variant-option--dropdowns">
          <label class="form__label" for="Option-{{ block.id }}-{{ forloop.index0 }}">
            {{ product_option.name  | escape }}:
            <span data-selected-value>
              {{- product_option.selected_value -}}
            </span>
          </label>
          <div
            class="select variant-option__select-wrapper"
            style="
              {%- if property_being_updated  -%}
                --variant-selects-swatch-width: clamp(10px,{{ new_width }}px, 50px);
              {%- endif -%}
            "
          >
            {% render 'product-variant-options',
              option: product_option,
              block: block,
              variant_style: variant_style,
              swatch_type: swatch_type,
              swatch_size: swatch_size,
              is_color: is_color,
              index: forloop.index0,
              product: product_resource
            %}
          </div>
        </div>
      {%- endif -%}
    {%- endfor -%}

    <script type="application/json" data-selected-variant>
      {{ product_resource.selected_or_first_available_variant | json }}
    </script>
  </variant-selects>
{% endunless %}

<script>
  {% assign selected_variant = product.selected_or_first_available_variant %}
  window.product_inventory_policy_array_{{ product.id }} = {
    '{{ selected_variant.id }}': '{{ selected_variant.inventory_policy }}',
  };
</script>
