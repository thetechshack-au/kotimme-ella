{%- liquid
  assign bl_id = block.id
  assign bl_stts = block.settings
  assign product_grid_type = bl_stts.product_grid_type
  if product_grid_type == 'carousel'
    assign columns_desktop = bl_stts.columns_desktop_carousel
  else
    assign columns_desktop = bl_stts.columns_desktop
  endif

  assign products = bl_stts.collection.products | default: (1..columns_desktop)

  assign products_to_display = bl_stts.collection.all_products_count
  assign max_tiems = bl_stts.products_to_show

  if bl_stts.collection.all_products_count > max_tiems
    assign products_to_display = max_tiems
    assign more_in_collection = true
  endif

  assign columns_mobile_int = bl_stts.columns_mobile | plus: 0

  assign columns_tablet = 2
  if columns_desktop == 1
    assign columns_tablet = 1
  elsif columns_desktop >= 4
    assign columns_tablet = 3
  endif

  assign columns_gap = bl_stts.columns_gap | append: 'px'
  assign rows_gap = bl_stts.rows_gap | append: 'px'

  assign is_carousel = false
  if product_grid_type == 'carousel'
    assign is_carousel = true

    assign enable_navigation = false
    if bl_stts.navigation == 'arrows-pagination' or bl_stts.navigation == 'arrows'
      assign enable_navigation = true
    endif

    assign enable_pagination = false
    if bl_stts.navigation == 'pagination' or bl_stts.navigation == 'arrows-pagination'
      assign enable_pagination = true
    endif
  endif

  if bl_stts.pagination_type == 'progressbar'
    assign progressbar_left = bl_stts.progressbar_left | append: 'px'
    assign progressbar_right = bl_stts.progressbar_right | append: 'px'
  endif
-%}

{%- capture progress_style -%}
style="{% if progressbar_left != blank %}--pl: {{ progressbar_left }};{% endif %}{% if progressbar_right != blank %}--pr: {{ progressbar_right }};{% endif %}"
{%- endcapture -%}

<div
  class="product-grid--block product-grid-{{ bl_id }} max-w-full size-style spacing-style"
  {{ block.shopify_attributes }}
  style="
    {% render 'size-style', settings: block.settings %}
    {% render 'spacing-style', settings: block.settings %}
  "
>
  {%- if is_carousel -%}
    {%- capture breakpoints -%}
      {
        "768": { "slidesPerView": {{ columns_tablet }} },
        "1024": { "slidesPerView": {{ columns_tablet }} },
        "1400": { "slidesPerView": {{ columns_desktop }} }
      }
    {%- endcapture -%}
    <swiper-component
      class="swiper-component-product-grid{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
      {%- render 'swiper-data',
        settings: bl_stts,
        slides_per_view: columns_mobile_int,
        space_between: columns_gap,
        breakpoints: breakpoints
      -%}
      style="
      {% render 'swiper-style',
        columns_mobile: columns_mobile_int,
        columns_tablet: columns_tablet,
        columns_desktop: columns_desktop,
        columns_gap: columns_gap,
      %}"
    >
      <div
        class="swiper"
        style="
          {% if block.settings.pagination_type == 'bullets' and block.settings.navigation == 'pagination' or block.settings.navigation == 'arrows-pagination' %}
          --dots-top-offset: {{ block.settings.dots_top_offset }}px;
          {% elsif block.settings.pagination_type == 'progressbar' and block.settings.navigation == 'pagination' or block.settings.navigation == 'arrows-pagination' %}
          --progress-top-offset: {{ block.settings.progress_top_offset }}px;
          {% endif %}
        "
      >
  {%- endif -%}
  <ul
    id="Slider-{{ bl_id }}"
    data-id="{{ bl_id }}"
    class="list-unstyled{% if is_carousel %} swiper-wrapper{% else %} grid-layout grid-layout--{{ columns_mobile_int }} md:grid-layout--{{ columns_tablet }} lg:grid-layout--{{ columns_desktop }}{% endif %} grid-layout-no-js"
    role="list"
    aria-label="{{ 'content.slider.name' | t }}"
    style="{% unless is_carousel %}--grid-desktop-horizontal-spacing: {{ columns_gap }}; --grid-desktop-vertical-spacing: {{ rows_gap }};{% endunless %}"
  >
    {% for product in products limit: max_tiems %}
      <li
        id="Slide-{{ bl_id }}-{{ forloop.index }}"
        class="product-grid-item{% if is_carousel %} swiper-slide{% endif %}"
        {% if settings.animations_reveal_on_scroll %}
          data-cascade style="--animation-order: {{ forloop.index }};"
        {% endif %}
      >
        {% content_for 'block', type: 'card-product-flex', id: 'product-slide-item', closest.product: product, columns_gap: columns_gap %}
      </li>
    {% endfor %}
  </ul>
  {%- if enable_pagination -%}
    {% if bl_stts.pagination_type == 'progressbar' %}
      <div {{ progress_style }}>
    {% endif %}
      <div class="swiper-pagination"></div>
    {% if bl_stts.pagination_type == 'progressbar' %}
    </div>
    {% endif %}
  {%- endif -%}
  {%- if enable_navigation -%}
    <div class="swiper-btns-wrap small-hide swiper-btns-wrap--{{ bl_stts.arrows_position }}">
      {%- render 'swiper-button' -%}
    </div>
  {%- endif -%}
  {%- if is_carousel -%}
    </div>
    </swiper-component>
  {%- endif -%}
</div>

{% schema %}
{
  "name": "t:names.product_grid",
  "tag": null,
  "blocks": [
    { "type": "@app" },
    { "type": "spacer" },
    { "type": "card-product-flex" },
    { "type": "_card-product-media-flex" },
    { "type": "_card-product-vendor-flex" },
    { "type": "_card-product-title-flex" },
    { "type": "_card-product-price-flex" },
    { "type": "_card-product-variant-flex" }
  ],
  "settings": [
    {
      "type": "header",
      "content": "t:content.size"
    },
    {
      "type": "select",
      "id": "width",
      "label": "t:settings.width_desktop",
      "options": [
        {
          "value": "fit-content",
          "label": "t:options.fit"
        },
        {
          "value": "fill",
          "label": "t:options.fill"
        },
        {
          "value": "custom",
          "label": "t:options.custom"
        }
      ],
      "default": "fit-content"
    },
    {
      "type": "range",
      "id": "custom_width",
      "label": "t:settings.custom_percent",
      "min": 1,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 100,
      "visible_if": "{{ block.settings.width == 'custom' }}"
    },
    {
      "type": "select",
      "id": "width_tablet",
      "label": "t:settings.width_tablet",
      "options": [
        {
          "value": "fit-content",
          "label": "t:options.fit"
        },
        {
          "value": "fill",
          "label": "t:options.fill"
        },
        {
          "value": "custom",
          "label": "t:options.custom"
        }
      ],
      "default": "fit-content"
    },
    {
      "type": "range",
      "id": "custom_width_tablet",
      "label": "t:settings.custom_percent",
      "min": 1,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 100,
      "visible_if": "{{ block.settings.width_tablet == 'custom' }}"
    },
    {
      "type": "select",
      "id": "width_mobile",
      "label": "t:settings.width_mobile",
      "options": [
        {
          "value": "fit-content",
          "label": "t:options.fit"
        },
        {
          "value": "fill",
          "label": "t:options.fill"
        },
        {
          "value": "custom",
          "label": "t:options.custom"
        }
      ],
      "default": "fit-content"
    },
    {
      "type": "range",
      "id": "custom_width_mobile",
      "label": "t:settings.custom_percent",
      "min": 1,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 100,
      "visible_if": "{{ block.settings.width_mobile == 'custom' }}"
    },
    {
      "type": "header",
      "content": "t:content.product_grid"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "t:settings.collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 25,
      "step": 1,
      "default": 4,
      "label": "t:settings.maximum_products_to_show"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 1,
      "max": 5,
      "step": 1,
      "default": 4,
      "label": "t:settings.number_of_columns_on_desktop",
      "visible_if": "{{ block.settings.product_grid_type == 'grid' }}"
    },
    {
      "type": "range",
      "id": "columns_desktop_carousel",
      "min": 1,
      "max": 6,
      "step": 0.5,
      "default": 4,
      "label": "t:settings.number_of_columns_on_desktop",
      "visible_if": "{{ block.settings.product_grid_type == 'carousel' }}"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "default": "2",
      "label": "t:settings.number_of_columns_on_mobile",
      "options": [
        {
          "value": "1",
          "label": "t:options.one_column"
        },
        {
          "value": "2",
          "label": "t:options.two_columns"
        }
      ]
    },
    {
      "type": "header",
      "content": "t:content.layout"
    },
    {
      "type": "select",
      "id": "product_grid_type",
      "label": "t:settings.layout_type",
      "options": [
        {
          "value": "grid",
          "label": "t:options.grid"
        },
        {
          "value": "carousel",
          "label": "t:options.carousel"
        }
      ],
      "default": "grid"
    },
    {
      "type": "range",
      "id": "columns_gap",
      "label": "t:settings.horizontal_gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 8
    },
    {
      "type": "range",
      "id": "rows_gap",
      "label": "t:settings.vertical_gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 8
    },
    {
      "type": "header",
      "content": "t:content.carousel",
      "visible_if": "{{ block.settings.product_grid_type == 'carousel' }}"
    },
    {
      "type": "select",
      "id": "navigation",
      "label": "t:settings.navigation",
      "visible_if": "{{ block.settings.product_grid_type == 'carousel' }}",
      "options": [
        {
          "value": "none",
          "label": "t:options.none"
        },
        {
          "value": "arrows",
          "label": "t:options.arrows"
        },
        {
          "value": "pagination",
          "label": "t:options.pagination"
        },
        {
          "value": "arrows-pagination",
          "label": "t:settings.arrows_and_pagination"
        }
      ],
      "default": "arrows"
    },
    {
      "type": "select",
      "id": "arrows_position",
      "label": "t:settings.arrows_position",
      "options": [
        {
          "value": "inside",
          "label": "t:options.inside_slide"
        },
        {
          "value": "bottom",
          "label": "t:options.bottom_slide"
        }
      ],
      "default": "inside",
      "visible_if": "{{ block.settings.navigation == 'arrows' or block.settings.navigation == 'arrows-pagination' and block.settings.product_grid_type == 'carousel' }}"
    },
    {
      "type": "select",
      "id": "pagination_type",
      "label": "t:settings.pagination_type",
      "visible_if": "{{ block.settings.navigation == 'pagination' or block.settings.navigation == 'arrows-pagination' }}",
      "options": [
        {
          "value": "bullets",
          "label": "t:options.dots"
        },
        {
          "value": "dynamic",
          "label": "t:options.dynamic"
        },
        {
          "value": "progressbar",
          "label": "t:options.progress"
        },
        {
          "value": "fraction",
          "label": "t:options.fraction"
        }
      ],
      "default": "bullets"
    },
    {
      "type": "range",
      "id": "dots_top_offset",
      "label": "t:settings.dots_top_offset",
      "min": 20,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 40,
      "visible_if": "{{ block.settings.pagination_type == 'bullets' and block.settings.navigation == 'pagination' or block.settings.navigation == 'arrows-pagination' }}"
    },
    {
      "type": "range",
      "id": "progress_top_offset",
      "label": "t:settings.progress_top_offset",
      "min": 20,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 40,
      "visible_if": "{{ block.settings.pagination_type == 'progressbar' and block.settings.navigation == 'pagination' or block.settings.navigation == 'arrows-pagination' }}"
    },
    {
      "type": "range",
      "id": "progressbar_left",
      "label": "t:settings.progressbar_left",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0,
      "visible_if": "{{ block.settings.pagination_type == 'progressbar' and section.settings.navigation == 'pagination' or section.settings.navigation == 'arrows-pagination' }}"
    },
    {
      "type": "range",
      "id": "progressbar_right",
      "label": "t:settings.progressbar_right",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0,
      "visible_if": "{{ block.settings.pagination_type == 'progressbar' and section.settings.navigation == 'pagination' or section.settings.navigation == 'arrows-pagination' }}"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "label": "t:settings.left",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "label": "t:settings.right",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "t:names.product_grid",
      "category": "t:categories.product",
      "blocks": [
        {
          "id": "product-slide-item",
          "type": "card-product-flex",
          "static": true,
          "settings": {
            "product": "{{ closest.product }}"
          },
          "blocks": [
            {
              "type": "_card-product-media-flex",
              "settings": {
                "product": "{{ closest.product }}",
                "image_ratio": "adapt",
                "show_secondary_image": true
              }
            },
            {
              "type": "spacer",
              "settings": {
                "spacer_height": 6
              }
            },
            {
              "type": "_card-product-information",
              "blocks": [
                {
                  "type": "_card-product-vendor-flex",
                  "settings": {
                    "product": "{{ closest.product }}"
                  }
                },
                {
                  "type": "_card-product-title-flex",
                  "settings": {
                    "product": "{{ closest.product }}"
                  }
                },
                {
                  "type": "_card-product-price-flex",
                  "settings": {
                    "product": "{{ closest.product }}"
                  }
                },
                {
                  "type": "_card-product-variant-flex",
                  "settings": {
                    "product": "{{ closest.product }}"
                  }
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
{% endschema %}
